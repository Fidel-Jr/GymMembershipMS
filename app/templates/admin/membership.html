

{% extends 'base.html' %}

{% block title %}Membership | Gym Membership Management{% endblock %}

{% block content %}
<div class="container-fluid">
    <h2 class="mb-4">Membership Management</h2>

    <!-- Assign Membership Form -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-dark">Assign Membership</h6>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('admin.membership') }}">
                        {{ form.hidden_tag() }}
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ form.member_id.label(class="form-label") }}
                                {{ form.member_id(class="form-select select2-member") }}
                            </div>
                            <div class="col-md-6 mb-3">
                                {{ form.plan_id.label(class="form-label") }}
                                {{ form.plan_id(class="form-select form-control selectPlan") }}
                            </div>
                            <div class="col-md-6 mb-3">
                                {{ form.start_date.label(class="form-label") }}
                                {{ form.start_date(class="form-control") }}
                            </div>
                            <div class="col-md-6 mb-3">
                                {{ form.payment_method.label(class="form-label") }}
                                {{ form.payment_method(class="form-select form-control") }}
                            </div>
                            <div class="col-12">
                                {{ form.submit(class="btn btn-primary") }}
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Membership Plans -->
        <div class="row">
            {% for plan in plans %}
            <div class="col-lg-4 mb-4">
                <div class="card shadow h-100 {% if plan.name == 'Premium Plan' %}border-warning{% endif %}">
                    <div class="card-header py-3" style="background-color: #f8b739;">
                        <h6 class="m-0 font-weight-bold text-white text-center">{{ plan.name }}</h6>
                    </div>
                    <div class="card-body">
                        <div class="text-center mb-4">
                            <h1 class="display-4 font-weight-bold">${{ plan.price }}</h1>
                            <p class="text-muted">per {{ plan.duration_months }} {{ 'month' if plan.duration_months == 1 else 'months' }}</p>
                        </div>
                        <ul class="list-group list-group-flush mb-4">
                            {% set features = plan.features.split(',') %}
                            {% for feature in features %}
                                <li class="list-group-item">
                                    <i class="fas fa-check text-success mr-2"></i> {{ feature.strip() }}
                                </li>
                            {% endfor %}
                        </ul>
                    <div class="text-center">
                            <button class="btn btn-outline-warning btn-lg text" data-plan="{{ plan.id }}">Select Plan</button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        

</div>

{% block extra_js %}
<script>
$(document).ready(function() {
    $('.select2-member').select2({
        theme: 'bootstrap-5',
        placeholder: 'Search by name or ID...',
        allowClear: true,
        width: '100%',
        minimumInputLength: 1,
        ajax: {
            url: '{{ url_for("admin.api_users") }}',
            dataType: 'json',
            delay: 250,
            data: function(params) {
                return { q: params.term };
            },
            processResults: function(data) {
                console.log('API returned:', data); // ✅ Debug log
                if (!data || !data.results) {
                    return { results: [] };
                }
                // Map results if text is not present
                return {
                    results: data.results.map(function(item) {
                        return {
                            id: item.id,
                            text: item.text || `${item.full_name} (#${item.id})`,
                            email: item.email,
                            phone: item.phone
                        };
                    })
                };
            },
            cache: true,
            error: function(xhr, status, error) {
                console.error('Select2 AJAX error:', status, error, xhr.responseText);
            }
        },
        templateResult: function(item) {
            if (!item.id) return item.text;
            var email = item.email ? `<div><i class="fas fa-envelope"></i> ${item.email}</div>` : '';
            var phone = item.phone ? `<div><i class="fas fa-phone"></i> ${item.phone}</div>` : '';
            return $(`<div>${item.text}${email}${phone}</div>`);
        },
/*************  ✨ Windsurf Command ⭐  *************/
        /**
         * Return the text or ID of the selected item to be displayed in the selection field.
         * This is called after the item is selected, and before the item is rendered in the selection field.
         * @param {Object} item - The selected item
         * @returns {string} - The text to be displayed in the selection field
         */
/*******  d752e90f-676b-45e4-87c6-f90a0426351e  *******/
        templateSelection: function(item) {
            return item.text || item.id;
        }
    });
    // Handle plan selection from cards
        $('.card button[data-plan]').click(function() {
            const planId = $(this).data('plan');
            $('.selectPlan').val(planId).trigger('change');
            $('html, body').animate({
                scrollTop: $("#assignMembershipForm").offset().top - 100
            }, 800);
        });
    // Handle member info display
    $('#memberSelect').on('select2:select', function(e) {
        const data = e.params.data;
        $('#memberEmail').text(data.email || '');
        $('#memberPhone').text(data.phone || '');
        $('#memberInfo').slideDown();
    });
    $('#memberSelect').on('select2:clear', function() {
        $('#memberInfo').slideUp();
    });
});
</script>

{% endblock %}
{% endblock %}
